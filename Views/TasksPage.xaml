<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:BrainWave.APP.ViewModels"
             x:Class="BrainWave.APP.Views.TasksPage"
             Title="Tasks"
             BackgroundColor="{AppThemeBinding Light=#F8F9FA, Dark=#1A1A1A}">

    <ContentPage.BindingContext>
        <vm:TasksViewModel />
    </ContentPage.BindingContext>

    <Grid RowDefinitions="Auto,*">
        
        <!-- Header -->
        <Frame Grid.Row="0" 
               BackgroundColor="{AppThemeBinding Light=#4A90E2, Dark=#2C5AA0}" 
               CornerRadius="0" 
               Padding="20" 
               Margin="0,0,0,10">
            <Grid ColumnDefinitions="*,Auto,Auto,Auto,Auto" ColumnSpacing="8">
                <VerticalStackLayout Grid.Column="0">
                    <Label Text="📋 My Tasks" 
                           FontSize="24" 
                           FontAttributes="Bold" 
                           TextColor="White" />
                    <Label Text="Stay organized and productive" 
                           FontSize="14" 
                           TextColor="White" 
                           Opacity="0.9" />
                </VerticalStackLayout>
                <Button Grid.Column="1"
                        Text="➕ Create"
                        BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#FFFFFF}"
                        TextColor="{AppThemeBinding Light=#4A90E2, Dark=#4A90E2}"
                        CornerRadius="8"
                        FontSize="12"
                        FontAttributes="Bold"
                        Padding="12,8"
                        VerticalOptions="Center"
                        Command="{Binding ShowCreateFormCommand}" />
                <Button Grid.Column="2"
                        Text="Refresh"
                        BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#FFFFFF}"
                        TextColor="{AppThemeBinding Light=#4A90E2, Dark=#4A90E2}"
                        CornerRadius="8"
                        FontSize="12"
                        FontAttributes="Bold"
                        Padding="12,8"
                        VerticalOptions="Center"
                        Command="{Binding RefreshCommand}" />
                <Button Grid.Column="3"
                        Text="🚪 Logout"
                        BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#FFFFFF}"
                        TextColor="{AppThemeBinding Light=#4A90E2, Dark=#4A90E2}"
                        CornerRadius="8"
                        FontSize="12"
                        FontAttributes="Bold"
                        Padding="12,8"
                        VerticalOptions="Center"
                        Command="{Binding LogoutCommand}" />
                <Button Grid.Column="4"
                        Text="❓"
                        BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#FFFFFF}"
                        TextColor="{AppThemeBinding Light=#4A90E2, Dark=#4A90E2}"
                        CornerRadius="8"
                        FontSize="16"
                        FontAttributes="Bold"
                        Padding="12,8"
                        VerticalOptions="Center"
                        Clicked="HelpButton_Clicked" />
            </Grid>
        </Frame>

        <!-- Main Content Area -->
        <Grid Grid.Row="1" RowDefinitions="Auto,*">
            
            <!-- Search and Filters -->
            <Frame Grid.Row="0" 
                   BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#2D2D2D}" 
                   CornerRadius="8" 
                   Padding="8" 
                   Margin="12,0,12,6"
                   HasShadow="True">
                <VerticalStackLayout Spacing="6">
                    <!-- Compact Search Bar -->
                    <Frame BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#404040}" 
                           CornerRadius="6" 
                           Padding="8" 
                           HasShadow="False">
                        <Grid ColumnDefinitions="Auto,*">
                            <Label Grid.Column="0" 
                                   Text="🔍" 
                                   FontSize="14" 
                                   VerticalOptions="Center" 
                                   Margin="0,0,6,0" />
                            <Entry Grid.Column="1" 
                                   Text="{Binding SearchText}" 
                                   Placeholder="Search tasks..." 
                                   BackgroundColor="Transparent" 
                                   TextColor="{AppThemeBinding Light=#333333, Dark=#FFFFFF}"
                                   PlaceholderColor="{AppThemeBinding Light=#999999, Dark=#AAAAAA}"
                                   FontSize="14" />
                        </Grid>
                    </Frame>
                    
                    <!-- Compact Controls in One Row -->
                    <Grid ColumnDefinitions="*,*,*,*" ColumnSpacing="6">
                        <Picker Grid.Column="0" 
                                Title="Priority" 
                                BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#404040}" 
                                TextColor="{AppThemeBinding Light=#333333, Dark=#FFFFFF}"
                                SelectedItem="{Binding PriorityFilter}"
                                FontSize="12"
                                HeightRequest="35">
                            <Picker.Items>
                                <x:String>All</x:String>
                                <x:String>High</x:String>
                                <x:String>Medium</x:String>
                                <x:String>Low</x:String>
                                <x:String>Critical</x:String>
                            </Picker.Items>
                        </Picker>
                        
                        <Picker Grid.Column="1" 
                                Title="Status" 
                                BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#404040}" 
                                TextColor="{AppThemeBinding Light=#333333, Dark=#FFFFFF}"
                                SelectedItem="{Binding StatusFilter}"
                                FontSize="12"
                                HeightRequest="35">
                            <Picker.Items>
                                <x:String>All</x:String>
                                <x:String>In Progress</x:String>
                                <x:String>Completed</x:String>
                            </Picker.Items>
                        </Picker>
                        
                        <Picker Grid.Column="2" 
                                Title="Sort By" 
                                BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#404040}" 
                                TextColor="{AppThemeBinding Light=#333333, Dark=#FFFFFF}"
                                SelectedItem="{Binding SortBy}"
                                FontSize="12"
                                HeightRequest="35">
                            <Picker.Items>
                                <x:String>Title</x:String>
                                <x:String>DueDate</x:String>
                                <x:String>Priority</x:String>
                                <x:String>Status</x:String>
                                <x:String>CreatedAt</x:String>
                            </Picker.Items>
                        </Picker>
                        
                        <Picker Grid.Column="3" 
                                Title="Order" 
                                BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#404040}" 
                                TextColor="{AppThemeBinding Light=#333333, Dark=#FFFFFF}"
                                SelectedItem="{Binding SortOrder}"
                                FontSize="12"
                                HeightRequest="35">
                            <Picker.Items>
                                <x:String>Ascending</x:String>
                                <x:String>Descending</x:String>
                            </Picker.Items>
                        </Picker>
                    </Grid>
                </VerticalStackLayout>
            </Frame>

            <!-- Task List or Create Form -->
            <Grid Grid.Row="1">
                
                <!-- Task List View -->
                <ScrollView IsVisible="{Binding ShowTaskList}">
                    <VerticalStackLayout Padding="12" Spacing="8">
                        <CollectionView ItemsSource="{Binding Items}" 
                                        BackgroundColor="Transparent">
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <SwipeView>
                                        <SwipeView.RightItems>
                                            <SwipeItems>
                                                <SwipeItem Text="Delete" 
                                                           BackgroundColor="Red" 
                                                           Command="{Binding Source={RelativeSource AncestorType={x:Type vm:TasksViewModel}}, Path=DeleteCommand}"
                                                           CommandParameter="{Binding .}" />
                                            </SwipeItems>
                                        </SwipeView.RightItems>
                                        
                                        <Frame BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#2D2D2D}" 
                                               CornerRadius="10" 
                                               Padding="12" 
                                               HasShadow="True">
                                            <Grid RowDefinitions="Auto,Auto,Auto" ColumnDefinitions="*,Auto">
                                                <!-- Task Title -->
                                                <Label Grid.Row="0" Grid.Column="0"
                                                       Text="{Binding Title}" 
                                                       FontSize="16" 
                                                       FontAttributes="Bold" 
                                                       TextColor="{AppThemeBinding Light=#333333, Dark=#FFFFFF}" />
                                                
                                                <!-- Priority Badge -->
                                                <Frame Grid.Row="0" Grid.Column="1"
                                                       BackgroundColor="{Binding Priority, Converter={StaticResource PriorityToColorConverter}}" 
                                                       CornerRadius="6" 
                                                       Padding="6,3" 
                                                       HasShadow="False">
                                                    <Label Text="{Binding Priority}" 
                                                           FontSize="12" 
                                                           FontAttributes="Bold" 
                                                           TextColor="White" />
                                                </Frame>
                                                
                                                <!-- Task Description -->
                                                <Label Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2"
                                                       Text="{Binding Description}" 
                                                       FontSize="14" 
                                                       TextColor="{AppThemeBinding Light=#666666, Dark=#CCCCCC}" 
                                                       Margin="0,8,0,0"
                                                       MaxLines="2"
                                                       LineBreakMode="TailTruncation" />
                                                
                                                <!-- Actions -->
                                                <HorizontalStackLayout Grid.Row="2" Grid.Column="2"
                                                                      Spacing="8" 
                                                                      Margin="0,8,0,0">
                                                    <Button Text="View" 
                                                            BackgroundColor="{AppThemeBinding Light=#4A90E2, Dark=#2C5AA0}" 
                                                            TextColor="White" 
                                                            CornerRadius="8" 
                                                            FontSize="10" 
                                                            Padding="8,4"
                                                            Command="{Binding Source={RelativeSource AncestorType={x:Type vm:TasksViewModel}}, Path=ViewCommand}"
                                                            CommandParameter="{Binding .}" />

                                                    <Button Text="Complete" 
                                                            BackgroundColor="{AppThemeBinding Light=#4CAF50, Dark=#2E7D32}" 
                                                            TextColor="White" 
                                                            CornerRadius="8" 
                                                            FontSize="10" 
                                                            Padding="8,4"
                                                            Command="{Binding Source={RelativeSource AncestorType={x:Type vm:TasksViewModel}}, Path=MarkCompletedCommand}"
                                                            CommandParameter="{Binding .}"
                                                            IsVisible="{Binding Status, Converter={StaticResource StatusToVisibilityConverter}, ConverterParameter=In Progress}" />
                                                    <Button Text="Export" 
                                                            BackgroundColor="{AppThemeBinding Light=#9C27B0, Dark=#7B1FA2}" 
                                                            TextColor="White" 
                                                            CornerRadius="8" 
                                                            FontSize="10" 
                                                            Padding="8,4"
                                                            Command="{Binding Source={RelativeSource AncestorType={x:Type vm:TasksViewModel}}, Path=ExportCommand}"
                                                            CommandParameter="{Binding .}" />
                                                </HorizontalStackLayout>
                                            </Grid>
                                        </Frame>
                                    </SwipeView>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>
                </ScrollView>

                <!-- Create/Edit Task Form -->
                <ScrollView IsVisible="{Binding ShowCreateForm}">
                    <VerticalStackLayout Padding="20" Spacing="16">
                        
                        <Label Text="{Binding FormTitle}" 
                               FontSize="24" 
                               FontAttributes="Bold" 
                               TextColor="{AppThemeBinding Light=#333333, Dark=#FFFFFF}" 
                               HorizontalOptions="Center" />
                        
                        <!-- Form Fields -->
                        <Frame BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#404040}" 
                               CornerRadius="12" 
                               Padding="16" 
                               HasShadow="False">
                            <VerticalStackLayout Spacing="4">
                                <Label Text="Task Title *" 
                                       FontSize="12" 
                                       FontAttributes="Bold" 
                                       TextColor="{AppThemeBinding Light=#666666, Dark=#CCCCCC}" />
                                <Entry Text="{Binding Editing.Title}" 
                                       BackgroundColor="Transparent" 
                                       TextColor="{AppThemeBinding Light=#333333, Dark=#FFFFFF}"
                                       PlaceholderColor="{AppThemeBinding Light=#999999, Dark=#AAAAAA}" />
                            </VerticalStackLayout>
                        </Frame>

                        <Frame BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#404040}" 
                               CornerRadius="12" 
                               Padding="16" 
                               HasShadow="False">
                            <VerticalStackLayout Spacing="4">
                                <Label Text="Description (Optional)" 
                                       FontSize="12" 
                                       FontAttributes="Bold" 
                                       TextColor="{AppThemeBinding Light=#666666, Dark=#CCCCCC}" />
                                <Editor Text="{Binding Editing.Description}" 
                                        BackgroundColor="Transparent" 
                                        TextColor="{AppThemeBinding Light=#333333, Dark=#FFFFFF}"
                                        PlaceholderColor="{AppThemeBinding Light=#999999, Dark=#AAAAAA}"
                                        HeightRequest="80" />
                            </VerticalStackLayout>
                        </Frame>

                        <Grid ColumnDefinitions="*,*" ColumnSpacing="12">
                            <Frame Grid.Column="0" 
                                   BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#404040}" 
                                   CornerRadius="12" 
                                   Padding="16" 
                                   HasShadow="False">
                                <VerticalStackLayout Spacing="4">
                                    <Label Text="Due Date" 
                                           FontSize="12" 
                                           FontAttributes="Bold" 
                                           TextColor="{AppThemeBinding Light=#666666, Dark=#CCCCCC}" />
                                    <DatePicker Date="{Binding Editing.DueDate}" 
                                                BackgroundColor="Transparent" 
                                                TextColor="{AppThemeBinding Light=#333333, Dark=#FFFFFF}" />
                                </VerticalStackLayout>
                            </Frame>
                            
                            <Frame Grid.Column="1" 
                                   BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#404040}" 
                                   CornerRadius="12" 
                                   Padding="16" 
                                   HasShadow="False">
                                <VerticalStackLayout Spacing="4">
                                    <Label Text="Priority" 
                                           FontSize="12" 
                                           FontAttributes="Bold" 
                                           TextColor="{AppThemeBinding Light=#666666, Dark=#CCCCCC}" />
                                    <Picker SelectedItem="{Binding Editing.Priority}">
                                        <Picker.Items>
                                            <x:String>Low</x:String>
                                            <x:String>Medium</x:String>
                                            <x:String>High</x:String>
                                            <x:String>Critical</x:String>
                                        </Picker.Items>
                                    </Picker>
                                </VerticalStackLayout>
                            </Frame>
                        </Grid>

                        <!-- Status Picker -->
                        <Frame BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#404040}" 
                               CornerRadius="12" 
                               Padding="16" 
                               HasShadow="False">
                            <VerticalStackLayout Spacing="4">
                                <Label Text="Status" 
                                       FontSize="12" 
                                       FontAttributes="Bold" 
                                       TextColor="{AppThemeBinding Light=#666666, Dark=#CCCCCC}" />
                                <Picker SelectedItem="{Binding Editing.Status}">
                                    <Picker.Items>
                                        <x:String>In Progress</x:String>
                                        <x:String>Completed</x:String>
                                    </Picker.Items>
                                </Picker>
                            </VerticalStackLayout>
                        </Frame>

                        <!-- Action Buttons -->
                        <Grid ColumnDefinitions="*,*" ColumnSpacing="12">
                            <Button Grid.Column="0"
                                    Text="Create Task" 
                                    Command="{Binding CreateCommand}" 
                                    BackgroundColor="{AppThemeBinding Light=#4A90E2, Dark=#2C5AA0}" 
                                    TextColor="White" 
                                    CornerRadius="12" 
                                    FontSize="16" 
                                    FontAttributes="Bold" 
                                    HeightRequest="50"
                                    IsEnabled="{Binding IsBusy, Converter={StaticResource InvertedBoolConverter}}"
                                    IsVisible="{Binding Editing.TaskID, Converter={StaticResource IntToBoolConverter}, ConverterParameter=0}" />
                            
                            <Button Grid.Column="1"
                                    Text="Update Task" 
                                    Command="{Binding UpdateCommand}" 
                                    BackgroundColor="{AppThemeBinding Light=#FFA500, Dark=#FF8C00}" 
                                    TextColor="White" 
                                    CornerRadius="12" 
                                    FontSize="16" 
                                    FontAttributes="Bold" 
                                    HeightRequest="50"
                                    IsEnabled="{Binding IsBusy, Converter={StaticResource InvertedBoolConverter}}"
                                    IsVisible="{Binding Editing.TaskID, Converter={StaticResource IntToBoolConverter}}" />
                        </Grid>

                        <Button Text="Back to Tasks" 
                                Command="{Binding BackToTasksCommand}" 
                                BackgroundColor="{AppThemeBinding Light=#6C757D, Dark=#495057}" 
                                TextColor="White" 
                                CornerRadius="12" 
                                FontSize="16" 
                                FontAttributes="Bold" 
                                HeightRequest="50" />

                        <ActivityIndicator IsVisible="{Binding IsBusy}" 
                                          IsRunning="{Binding IsBusy}" 
                                          Color="{AppThemeBinding Light=#4A90E2, Dark=#2C5AA0}" />
                    </VerticalStackLayout>
                </ScrollView>
            </Grid>
        </Grid>


    </Grid>
</ContentPage>