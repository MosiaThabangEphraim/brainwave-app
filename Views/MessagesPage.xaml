<?xml version="1.0" encoding="utf-8" ?>
<ContentPage x:Class="BrainWave.APP.Views.MessagesPage"
             xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:BrainWave.APP.ViewModels"
             Title="{Binding CollaborationName}">

    <ContentPage.BindingContext>
        <vm:MessagesViewModel />
    </ContentPage.BindingContext>

    <Grid RowDefinitions="Auto,*,Auto">
        
        <!-- Header with Back Button -->
        <Frame Grid.Row="0"
               BackgroundColor="{AppThemeBinding Light=#4A90E2, Dark=#2C5AA0}"
               CornerRadius="0"
               Padding="16,12"
               HasShadow="True">
            <Grid ColumnDefinitions="Auto,*,Auto">
                <Button Grid.Column="0"
                        Text="â† Back"
                        BackgroundColor="Transparent"
                        TextColor="White"
                        FontSize="16"
                        FontAttributes="Bold"
                        Clicked="BackButton_Clicked" />
                <Label Grid.Column="1"
                       Text="{Binding CollaborationName}"
                       FontSize="18"
                       FontAttributes="Bold"
                       TextColor="White"
                       HorizontalOptions="Center"
                       VerticalOptions="Center" />
                <Label Grid.Column="2"
                       Text="ðŸ’¬"
                       FontSize="20"
                       HorizontalOptions="End"
                       VerticalOptions="Center" />
            </Grid>
        </Frame>
        
        <!-- Messages List -->
        <RefreshView Grid.Row="1" 
                     IsRefreshing="{Binding IsLoading}"
                     Command="{Binding RefreshMessagesCommand}">
            <CollectionView ItemsSource="{Binding Messages}"
                            BackgroundColor="Transparent">
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Grid Padding="12,8" Margin="8,4">
                            <Frame BackgroundColor="{AppThemeBinding Light=#F8F9FA, Dark=#2D2D30}"
                                   CornerRadius="12"
                                   Padding="16"
                                   HasShadow="True">
                                <VerticalStackLayout Spacing="8">
                                    <!-- Message Header -->
                                    <Grid ColumnDefinitions="*,Auto">
                                        <Label Grid.Column="0"
                                               Text="{Binding UserName}"
                                               FontSize="14"
                                               FontAttributes="Bold"
                                               TextColor="{AppThemeBinding Light=#4A90E2, Dark=#5BA0F2}" />
                                        <Label Grid.Column="1"
                                               Text="{Binding SentAt, Converter={StaticResource UtcToLocalTimeConverter}, StringFormat='{0:MMM dd, HH:mm}'}"
                                               FontSize="12"
                                               TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}" />
                                    </Grid>
                                    
                                    <!-- Message Content -->
                                    <Label Text="{Binding Content}"
                                           FontSize="16"
                                           TextColor="{AppThemeBinding Light=#333333, Dark=#FFFFFF}"
                                           LineBreakMode="WordWrap" />
                                </VerticalStackLayout>
                            </Frame>
                        </Grid>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
                
                <CollectionView.EmptyView>
                    <VerticalStackLayout HorizontalOptions="Center" 
                                         VerticalOptions="Center" 
                                         Spacing="16"
                                         Margin="40">
                        <Label Text="ðŸ’¬"
                               FontSize="48"
                               HorizontalOptions="Center" />
                        <Label Text="No messages yet"
                               FontSize="18"
                               FontAttributes="Bold"
                               TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}"
                               HorizontalOptions="Center" />
                        <Label Text="Start the conversation by sending a message below!"
                               FontSize="14"
                               TextColor="{AppThemeBinding Light=#999999, Dark=#777777}"
                               HorizontalOptions="Center"
                               HorizontalTextAlignment="Center" />
                    </VerticalStackLayout>
                </CollectionView.EmptyView>
            </CollectionView>
        </RefreshView>

        <!-- Message Input -->
        <Frame Grid.Row="2"
               BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#1E1E1E}"
               CornerRadius="0"
               Padding="16"
               HasShadow="True">
            <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto">
                
                <!-- Message Input -->
                <Entry Grid.Row="0" Grid.Column="0"
                       Text="{Binding NewMessage}"
                       Placeholder="Type your message..."
                       PlaceholderColor="{AppThemeBinding Light=#999999, Dark=#AAAAAA}"
                       BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#404040}"
                       TextColor="{AppThemeBinding Light=#333333, Dark=#FFFFFF}"
                       FontSize="16"
                       Margin="0,0,12,0" />

                <!-- Send Button -->
                <Button Grid.Row="0" Grid.Column="1"
                        Text="Send"
                        BackgroundColor="{AppThemeBinding Light=#4A90E2, Dark=#5BA0F2}"
                        TextColor="White"
                        CornerRadius="8"
                        FontSize="14"
                        FontAttributes="Bold"
                        Padding="20,12"
                        Command="{Binding SendMessageCommand}" />

                <!-- Character Count (Optional) -->
                <Label Grid.Row="1" Grid.ColumnSpan="2"
                       Text="{Binding NewMessage.Length, StringFormat='{0} characters'}"
                       FontSize="12"
                       TextColor="{AppThemeBinding Light=#999999, Dark=#777777}"
                       HorizontalOptions="End"
                       Margin="0,4,0,0" />
            </Grid>
        </Frame>
    </Grid>
</ContentPage>
