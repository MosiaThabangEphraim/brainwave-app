<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:BrainWave.APP.ViewModels"
             x:Class="BrainWave.APP.Views.CollaborationPage"
             Title="Collaboration"
             BackgroundColor="{AppThemeBinding Light=#F8F9FA, Dark=#1A1A1A}">


    <Grid RowDefinitions="Auto,*">
        
        <!-- Header -->
        <Frame Grid.Row="0" 
               BackgroundColor="{AppThemeBinding Light=#4A90E2, Dark=#2C5AA0}" 
               CornerRadius="0" 
               Padding="20" 
               Margin="0,0,0,10">
            <Grid ColumnDefinitions="*,Auto,Auto,Auto,Auto" ColumnSpacing="8">
                <VerticalStackLayout Grid.Column="0">
                    <Label Text="🤝 My Collaborations" 
                           FontSize="24" 
                           FontAttributes="Bold" 
                           TextColor="White" />
                    <Label Text="Connect and work together" 
                           FontSize="14" 
                           TextColor="White" 
                           Opacity="0.9" />
                </VerticalStackLayout>
                <Button Grid.Column="1"
                        Text="➕ Create"
                        BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#FFFFFF}"
                        TextColor="{AppThemeBinding Light=#4A90E2, Dark=#4A90E2}"
                        CornerRadius="8"
                        FontSize="12"
                        FontAttributes="Bold"
                        Padding="12,8"
                        VerticalOptions="Center"
                        Command="{Binding ShowCreateFormCommand}" />
                <Button Grid.Column="2"
                        Text="Refresh"
                        BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#FFFFFF}"
                        TextColor="{AppThemeBinding Light=#4A90E2, Dark=#4A90E2}"
                        CornerRadius="8"
                        FontSize="12"
                        FontAttributes="Bold"
                        Padding="12,8"
                        VerticalOptions="Center"
                        Command="{Binding RefreshCommand}" />
                <Button Grid.Column="3"
                        Text="🚪 Logout"
                        BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#FFFFFF}"
                        TextColor="{AppThemeBinding Light=#4A90E2, Dark=#4A90E2}"
                        CornerRadius="8"
                        FontSize="12"
                        FontAttributes="Bold"
                        Padding="12,8"
                        VerticalOptions="Center"
                        Command="{Binding LogoutCommand}" />
                <Button Grid.Column="4"
                        Text="❓"
                        BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#FFFFFF}"
                        TextColor="{AppThemeBinding Light=#4A90E2, Dark=#4A90E2}"
                        CornerRadius="8"
                        FontSize="16"
                        FontAttributes="Bold"
                        Padding="12,8"
                        VerticalOptions="Center"
                        Clicked="HelpButton_Clicked" />
            </Grid>
        </Frame>

        <!-- Main Content Area -->
        <Grid Grid.Row="1" RowDefinitions="Auto,*">
            
            <!-- Search and Filters -->
            <Frame Grid.Row="0" 
                   BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#2D2D2D}" 
                   CornerRadius="8" 
                   Padding="8" 
                   Margin="12,0,12,6"
                   HasShadow="True">
                <VerticalStackLayout Spacing="6">
                    <!-- Search Bar -->
                    <Frame BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#404040}" 
                           CornerRadius="6" 
                           Padding="8" 
                           HasShadow="False">
                        <Grid ColumnDefinitions="Auto,*">
                            <Label Grid.Column="0" 
                                   Text="🔍" 
                                   FontSize="14" 
                                   VerticalOptions="Center" 
                                   Margin="0,0,6,0" />
                            <Entry Grid.Column="1" 
                                   Text="{Binding SearchText}" 
                                   Placeholder="Search..." 
                                   BackgroundColor="Transparent" 
                                   TextColor="{AppThemeBinding Light=#333333, Dark=#FFFFFF}"
                                   PlaceholderColor="{AppThemeBinding Light=#999999, Dark=#AAAAAA}"
                                   FontSize="14" />
                        </Grid>
                    </Frame>
                    
                    <!-- Sort Controls and Action Buttons -->
                    <Grid ColumnDefinitions="*,*,Auto" ColumnSpacing="6">
                        <Picker Grid.Column="0" 
                                Title="Sort By" 
                                BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#404040}" 
                                TextColor="{AppThemeBinding Light=#333333, Dark=#FFFFFF}"
                                SelectedItem="{Binding SortBy}"
                                FontSize="12"
                                HeightRequest="35">
                            <Picker.Items>
                                <x:String>Title</x:String>
                            </Picker.Items>
                        </Picker>
                        
                        <Picker Grid.Column="1" 
                                Title="Sort Order" 
                                BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#404040}" 
                                TextColor="{AppThemeBinding Light=#333333, Dark=#FFFFFF}"
                                SelectedItem="{Binding SortOrder}"
                                FontSize="12"
                                HeightRequest="35">
                            <Picker.Items>
                                <x:String>Ascending</x:String>
                                <x:String>Descending</x:String>
                            </Picker.Items>
                        </Picker>
                        
                        <Button Grid.Column="2" 
                                Text="Join" 
                                BackgroundColor="{AppThemeBinding Light=#FFA500, Dark=#FF8C00}" 
                                TextColor="White" 
                                CornerRadius="8" 
                                FontSize="12"
                                FontAttributes="Bold"
                                Padding="12,8"
                                VerticalOptions="Center"
                                Command="{Binding ShowJoinCollaborationCommand}" />
                    </Grid>
                </VerticalStackLayout>
            </Frame>

            <!-- Collaborations List -->
            <Grid Grid.Row="1">
                
                <!-- Collaborations List View -->
                <ScrollView IsVisible="{Binding ShowCollaborationsList}">
                    <VerticalStackLayout Padding="12" Spacing="8">
                        
                        <!-- Empty State -->
                        <Frame IsVisible="{Binding Items.Count, Converter={StaticResource StringToBoolConverter}, ConverterParameter=invert}"
                               BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#2D2D2D}" 
                               CornerRadius="16" 
                               Padding="40" 
                               HasShadow="True">
                            <VerticalStackLayout Spacing="16" HorizontalOptions="Center">
                                <Label Text="🤝" FontSize="48" HorizontalOptions="Center" />
                                <Label Text="No Collaborations Yet" 
                                       FontSize="18" 
                                       FontAttributes="Bold" 
                                       TextColor="{AppThemeBinding Light=#333333, Dark=#FFFFFF}" 
                                       HorizontalOptions="Center" />
                                <Label Text="Start collaborating by creating your first project" 
                                       FontSize="14" 
                                       TextColor="{AppThemeBinding Light=#666666, Dark=#CCCCCC}" 
                                       HorizontalOptions="Center" 
                                       HorizontalTextAlignment="Center" />
                            </VerticalStackLayout>
                        </Frame>

                        <!-- Collaboration Items -->
                        <CollectionView ItemsSource="{Binding Items}" 
                                        BackgroundColor="Transparent">
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <SwipeView>
                                        <SwipeView.RightItems>
                                            <SwipeItems>
                                                <SwipeItem Text="Delete" 
                                                           BackgroundColor="Red" 
                                                           Command="{Binding Source={RelativeSource AncestorType={x:Type vm:CollaborationViewModel}}, Path=DeleteCommand}"
                                                           CommandParameter="{Binding .}" />
                                            </SwipeItems>
                                        </SwipeView.RightItems>
                                        
                                        <Frame BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#2D2D2D}" 
                                               CornerRadius="10" 
                                               Padding="16" 
                                               HasShadow="True"
                                               Margin="0,4">
                                            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12" RowSpacing="8">
                                                
                                                <!-- Content (Left Side) -->
                                                <VerticalStackLayout Grid.Column="0" Spacing="8">
                                                    <!-- Title -->
                                                    <Label Text="{Binding Name}" 
                                                           FontSize="16" 
                                                           FontAttributes="Bold" 
                                                           TextColor="{AppThemeBinding Light=#333333, Dark=#FFFFFF}"
                                                           LineBreakMode="WordWrap" />
                                                    
                                                    <!-- Description -->
                                                    <Label Text="{Binding Description}" 
                                                           FontSize="14" 
                                                           TextColor="{AppThemeBinding Light=#666666, Dark=#CCCCCC}" 
                                                           LineBreakMode="WordWrap"
                                                           MaxLines="3" />
                                                    
                                                    <!-- Task and Role -->
                                                    <Label Text="{Binding TaskTitle, StringFormat='📋 Task: {0}'}" 
                                                           FontSize="14" 
                                                           TextColor="{AppThemeBinding Light=#4A90E2, Dark=#90CAF9}" 
                                                           LineBreakMode="WordWrap" />
                                                    
                                                    <Label Text="{Binding Role, StringFormat='👤 Role: {0}'}" 
                                                           FontSize="14" 
                                                           TextColor="{AppThemeBinding Light=#FF6B35, Dark=#FF8A65}" 
                                                           LineBreakMode="WordWrap" />
                                                </VerticalStackLayout>
                                                
                                                <!-- Action Buttons (Right Side) -->
                                                <Grid Grid.Column="1" 
                                                      RowDefinitions="Auto,Auto" 
                                                      ColumnDefinitions="*,*,*" 
                                                      RowSpacing="6" 
                                                      ColumnSpacing="6" 
                                                      VerticalOptions="Start">
                                                    
                                                    <!-- Top Row: View, Token, Users -->
                                                    <Button Grid.Row="0" Grid.Column="0"
                                                            Text="View" 
                                                            BackgroundColor="{AppThemeBinding Light=#4A90E2, Dark=#2C5AA0}" 
                                                            TextColor="White" 
                                                            CornerRadius="6" 
                                                            FontSize="10" 
                                                            Padding="16,6"
                                                            WidthRequest="80"
                                                            Command="{Binding Source={RelativeSource AncestorType={x:Type vm:CollaborationViewModel}}, Path=ViewCommand}"
                                                            CommandParameter="{Binding .}" />
                                                    
                                                    <Button Grid.Row="0" Grid.Column="1"
                                                            Text="Token" 
                                                            BackgroundColor="{AppThemeBinding Light=#9C27B0, Dark=#BA68C8}" 
                                                            TextColor="White" 
                                                            CornerRadius="6" 
                                                            FontSize="10" 
                                                            Padding="8,4"
                                                            Command="{Binding Source={RelativeSource AncestorType={x:Type vm:CollaborationViewModel}}, Path=ShowTokenCommand}"
                                                            CommandParameter="{Binding .}" />
                                                    
                                                    <Button Grid.Row="0" Grid.Column="2"
                                                            Text="Users" 
                                                            BackgroundColor="{AppThemeBinding Light=#4CAF50, Dark=#2E7D32}" 
                                                            TextColor="White" 
                                                            CornerRadius="6" 
                                                            FontSize="10" 
                                                            Padding="8,4"
                                                            Command="{Binding Source={RelativeSource AncestorType={x:Type vm:CollaborationViewModel}}, Path=ViewUsersCommand}"
                                                            CommandParameter="{Binding .}" />
                                                    
                                                    <!-- Bottom Row: Delete, Messages, Leave -->
                                                    <Button Grid.Row="1" Grid.Column="0"
                                                            Text="Delete" 
                                                            BackgroundColor="{AppThemeBinding Light=#F44336, Dark=#D32F2F}" 
                                                            TextColor="White" 
                                                            CornerRadius="6" 
                                                            FontSize="10" 
                                                            Padding="8,4"
                                                            Command="{Binding Source={RelativeSource AncestorType={x:Type vm:CollaborationViewModel}}, Path=DeleteCommand}"
                                                            CommandParameter="{Binding .}" />
                                                    
                                                    <Button Grid.Row="1" Grid.Column="1"
                                                            Text="Messages" 
                                                            BackgroundColor="{AppThemeBinding Light=#2196F3, Dark=#1976D2}" 
                                                            TextColor="White" 
                                                            CornerRadius="6" 
                                                            FontSize="10" 
                                                            Padding="8,4"
                                                            Command="{Binding Source={RelativeSource AncestorType={x:Type vm:CollaborationViewModel}}, Path=MessagesCommand}"
                                                            CommandParameter="{Binding .}" />
                                                    
                                                    <Button Grid.Row="1" Grid.Column="2"
                                                            Text="Leave" 
                                                            BackgroundColor="{AppThemeBinding Light=#FF9800, Dark=#F57C00}" 
                                                            TextColor="White" 
                                                            CornerRadius="6" 
                                                            FontSize="10" 
                                                            Padding="8,4"
                                                            Command="{Binding Source={RelativeSource AncestorType={x:Type vm:CollaborationViewModel}}, Path=LeaveCommand}"
                                                            CommandParameter="{Binding .}" />
                                                </Grid>
                                            </Grid>
                                        </Frame>
                                    </SwipeView>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>
                </ScrollView>


            </Grid>
        </Grid>

        <!-- Collaboration Details Popup -->
        <Grid x:Name="CollaborationPopup" 
              IsVisible="False"
              BackgroundColor="Transparent"
              VerticalOptions="FillAndExpand"
              HorizontalOptions="FillAndExpand">
            
            <!-- Semi-transparent overlay -->
            <BoxView BackgroundColor="Black" 
                     Opacity="0.5" 
                     VerticalOptions="FillAndExpand" 
                     HorizontalOptions="FillAndExpand">
                <BoxView.GestureRecognizers>
                    <TapGestureRecognizer Tapped="CloseCollaborationPopupOverlay_Clicked" />
                </BoxView.GestureRecognizers>
            </BoxView>
            
            <!-- Popup content -->
            <Frame BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#2D2D2D}" 
                   CornerRadius="16" 
                   Padding="20" 
                   Margin="40"
                   HasShadow="True"
                   VerticalOptions="Center"
                   HorizontalOptions="Center"
                   WidthRequest="400"
                   HeightRequest="450">
            <ScrollView>
                <VerticalStackLayout Spacing="16">
                    
                    <!-- Popup Header -->
                    <Grid ColumnDefinitions="*,Auto">
                        <Label Grid.Column="0" 
                               Text="🤝 Collaboration Details" 
                               FontSize="20" 
                               FontAttributes="Bold" 
                               TextColor="{AppThemeBinding Light=#333333, Dark=#FFFFFF}" />
                        <Button Grid.Column="1" 
                                Text="✕" 
                                BackgroundColor="Transparent" 
                                TextColor="{AppThemeBinding Light=#666666, Dark=#CCCCCC}" 
                                FontSize="18" 
                                FontAttributes="Bold"
                                Padding="0"
                                Clicked="CloseCollaborationPopup_Clicked" />
                    </Grid>
                    
                    <!-- Collaboration Title -->
                    <Frame BackgroundColor="{AppThemeBinding Light=#F8F9FA, Dark=#404040}" 
                           CornerRadius="8" 
                           Padding="12" 
                           HasShadow="False">
                        <VerticalStackLayout Spacing="4">
                            <Label Text="Title" 
                                   FontSize="12" 
                                   FontAttributes="Bold" 
                                   TextColor="{AppThemeBinding Light=#666666, Dark=#CCCCCC}" />
                            <Entry x:Name="PopupCollaborationTitle" 
                                   Text="" 
                                   BackgroundColor="Transparent" 
                                   TextColor="{AppThemeBinding Light=#333333, Dark=#FFFFFF}"
                                   FontSize="16" />
                        </VerticalStackLayout>
                    </Frame>
                    
                    <!-- Collaboration Description -->
                    <Frame BackgroundColor="{AppThemeBinding Light=#F8F9FA, Dark=#404040}" 
                           CornerRadius="8" 
                           Padding="12" 
                           HasShadow="False">
                        <VerticalStackLayout Spacing="4">
                            <Label Text="Description" 
                                   FontSize="12" 
                                   FontAttributes="Bold" 
                                   TextColor="{AppThemeBinding Light=#666666, Dark=#CCCCCC}" />
                            <Editor x:Name="PopupCollaborationDescription" 
                                    Text="" 
                                    BackgroundColor="Transparent" 
                                    TextColor="{AppThemeBinding Light=#333333, Dark=#FFFFFF}"
                                    HeightRequest="80" />
                        </VerticalStackLayout>
                    </Frame>
                    
                    <!-- User Role -->
                    <Frame BackgroundColor="{AppThemeBinding Light=#F8F9FA, Dark=#404040}" 
                           CornerRadius="8" 
                           Padding="12" 
                           HasShadow="False">
                        <VerticalStackLayout Spacing="4">
                            <Label Text="Your Role" 
                                   FontSize="12" 
                                   FontAttributes="Bold" 
                                   TextColor="{AppThemeBinding Light=#666666, Dark=#CCCCCC}" />
                            <Entry x:Name="PopupUserRole" 
                                   Text="" 
                                   BackgroundColor="Transparent" 
                                   TextColor="{AppThemeBinding Light=#333333, Dark=#FFFFFF}"
                                   FontSize="16"
                                   Placeholder="Enter your role in this collaboration" />
                        </VerticalStackLayout>
                    </Frame>
                    
                    <!-- Task Information (Read-only) -->
                    <Frame BackgroundColor="{AppThemeBinding Light=#E3F2FD, Dark=#0D47A1}" 
                           CornerRadius="8" 
                           Padding="12" 
                           HasShadow="False">
                        <VerticalStackLayout Spacing="4">
                            <Label Text="Related Task" 
                                   FontSize="12" 
                                   FontAttributes="Bold" 
                                   TextColor="{AppThemeBinding Light=#1976D2, Dark=#90CAF9}" />
                            <Label x:Name="PopupTaskTitle" 
                                   Text="" 
                                   FontSize="14" 
                                   TextColor="{AppThemeBinding Light=#1976D2, Dark=#90CAF9}" />
                        </VerticalStackLayout>
                    </Frame>
                    
                    <!-- Action Buttons -->
                    <Grid ColumnDefinitions="*,*,*" ColumnSpacing="8">
                        <Button Grid.Column="0"
                                Text="💾 Update" 
                                BackgroundColor="{AppThemeBinding Light=#4CAF50, Dark=#388E3C}" 
                                TextColor="White" 
                                CornerRadius="8" 
                                FontSize="14" 
                                FontAttributes="Bold" 
                                HeightRequest="40"
                                Clicked="UpdateCollaboration_Clicked" />
                        
                        <Button Grid.Column="1"
                                Text="🚪 Leave" 
                                BackgroundColor="{AppThemeBinding Light=#FF9800, Dark=#F57C00}" 
                                TextColor="White" 
                                CornerRadius="8" 
                                FontSize="14" 
                                FontAttributes="Bold" 
                                HeightRequest="40"
                                Clicked="LeaveCollaboration_Clicked" />
                        
                        <Button Grid.Column="2"
                                Text="❌ Cancel" 
                                BackgroundColor="{AppThemeBinding Light=#9E9E9E, Dark=#616161}" 
                                TextColor="White" 
                                CornerRadius="8" 
                                FontSize="14" 
                                FontAttributes="Bold" 
                                HeightRequest="40"
                                Clicked="CloseCollaborationPopup_Clicked" />
                    </Grid>
                    
                </VerticalStackLayout>
            </ScrollView>
            </Frame>
        </Grid>

    </Grid>
</ContentPage>